---
update_leaf:
  description: >-
    Fetch the leaf's current state.
    Calling it directly with "service: script.update_leaf"
    will ensure the calling script will wait for the update.
  mode: queued
  sequence:
    - repeat:
        while:
          - >
            {{ as_timestamp(now()) -
               as_timestamp(states('sensor.leaf_battery_last_update'), 0)
               > 600 }}
          - "{{ repeat.index <= 6 }}"
        sequence:
          - service: mqtt.publish
            data:
              topic: "leaf/command/battery"
              payload: "update"
          - wait_for_trigger:
              - platform: state
                entity_id: sensor.leaf_battery_last_received
            timeout: "00:03:00"
          - delay: "00:00:02"
    - choose:
        - conditions: >
            {{ as_timestamp(now()) -
               as_timestamp(states('sensor.leaf_battery_last_received'), 0)
               >= 240 }}
          sequence:
            - service: notify.all_people
              data:
                message: >
                  Erreur d'obtention des données de la Leaf:
                  Impossible d'effectuer une tentative de mise à jour.
        - conditions: >
            {{ as_timestamp(now()) -
               as_timestamp(states('sensor.leaf_battery_last_update'), 0)
               > 600 }}
          sequence:
            - service: notify.all_people
              data:
                message: >
                  Erreur d'obtention des données de la Leaf:
                  Les dernières valeurs obtenues sont trop vieilles
